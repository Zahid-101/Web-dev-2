name: AWS Production Deployment

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd ~
            # 1. Force a clean clone to ensure NO missing files
            rm -rf urban-harvest-hub
            git clone https://github.com/Zahid-101/Web-dev-2.git urban-harvest-hub
            
            cd urban-harvest-hub

            # 2. Smart Directory Detection
            if [ -d "backend" ]; then
              echo "Moving into backend folder..."
              cd backend
            fi

            # 3. Install and Launch
            npm install --production
            pm2 delete harvest-api || true
            pm2 start server.js --name "harvest-api"
            pm2 save